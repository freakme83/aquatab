<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zen Akvaryum: State & Trait Sim</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{
      background:#020617;color:#f8fafc;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      margin:0;height:100vh;overflow:hidden;display:flex;align-items:center;justify-content:center;
    }

    /* App layout */
    #app{
      width:92vw;max-width:1200px;height:74vh;
      display:flex;gap:14px;
    }

    /* Tank */
    #aquarium-wrapper{
      position:relative;flex:1;
      background:linear-gradient(180deg,#1e40af 0%,#1e3a8a 100%);
      border:8px solid #334155;border-radius:20px;
      box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);
      overflow:hidden;
      min-width:520px;
    }
    canvas{display:block;}

    #sand{
      position:absolute;bottom:0;width:100%;height:60px;
      background:#ca8a04;border-top:4px solid #a16207;
      z-index:10;pointer-events:none;
    }

    #aquarium-timer{
      position:absolute;bottom:70px;right:18px;z-index:50;
      font-family:monospace;background:rgba(0,0,0,0.4);
      padding:4px 12px;border-radius:8px;font-size:.8rem;
      color:rgba(255,255,255,0.65);border:1px solid rgba(255,255,255,0.12);
    }

    .bubble{
      position:absolute;background:rgba(255,255,255,0.2);border-radius:50%;
      pointer-events:none;animation:rise 8s linear infinite;
    }
    @keyframes rise{
      0%{transform:translateY(100%) scale(1);opacity:0}
      50%{opacity:.4}
      100%{transform:translateY(-200px) scale(1.5);opacity:0}
    }

    .notification{
      position:fixed;bottom:100px;left:50%;transform:translateX(-50%);
      background:rgba(15,23,42,0.9);padding:8px 16px;border-radius:20px;
      z-index:1000;font-size:.8rem;border:1px solid rgba(255,255,255,0.2);
    }
    .hidden{display:none;}

    /* Right panel (always open) */
    #right-panel{
      width:330px;min-width:330px;height:100%;
      background:rgba(15,23,42,0.92);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:18px;
      box-shadow:0 20px 25px -5px rgba(0,0,0,0.35);
      overflow:hidden;
      display:flex;flex-direction:column;
    }
    #right-panel header{
      padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.10);
      background:rgba(2,6,23,0.35);
    }
    #right-panel .section{
      padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.08);
    }
    #log{
      flex:1;overflow:auto;padding:12px 16px;
    }
    #log .item{
      font-size:12px;color:rgba(226,232,240,0.85);
      padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.08);
    }
    #log .item:last-child{border-bottom:none;}
    .mini{
      font-size:11px;color:rgba(226,232,240,0.65);
    }
    .btn{
      border-radius:10px;padding:10px 12px;font-size:12px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(30,41,59,0.45);
      transition:transform .12s ease, background .12s ease;
    }
    .btn:hover{background:rgba(30,41,59,0.65);transform:translateY(-1px)}
    .btn:disabled{opacity:.35;cursor:not-allowed;transform:none}
    .btn-primary{background:rgba(37,99,235,0.65)}
    .btn-primary:hover{background:rgba(37,99,235,0.85)}
    .btn-teal{background:rgba(13,148,136,0.65)}
    .btn-teal:hover{background:rgba(13,148,136,0.85)}
    .btn-red{background:rgba(220,38,38,0.55)}
    .btn-red:hover{background:rgba(220,38,38,0.75)}
    .price{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      color:rgba(250,204,21,0.95);
    }
  </style>
</head>

<body>
  <div id="app">
    <div id="aquarium-wrapper">
      <canvas id="aquariumCanvas"></canvas>
      <div id="sand"></div>
      <div id="aquarium-timer">Süre: 00:00</div>
      <div id="notif" class="notification hidden"></div>
    </div>

    <!-- Always-open Zen Panel -->
    <aside id="right-panel">
      <header>
        <div class="flex items-center justify-between">
          <div class="text-lg font-bold">Zen Panel</div>
          <div class="mini" id="zenHint">Gözlemle. Az dokun.</div>
        </div>
        <div class="mt-2 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
          <div class="flex justify-between"><span class="opacity-70">Bütçe</span><span id="moneyText" class="price">0 ₺</span></div>
          <div class="flex justify-between"><span class="opacity-70">Sıcaklık</span><span id="tempText">24°C</span></div>
          <div class="flex justify-between"><span class="opacity-70">Temizlik</span><span id="cleanText">100%</span></div>
          <div class="flex justify-between"><span class="opacity-70">Canlı</span><span id="fishCountText">6</span></div>
        </div>
      </header>

      <div class="section">
        <div class="text-xs uppercase opacity-70 mb-2">Kontrol</div>
        <div class="grid grid-cols-2 gap-2">
          <button class="btn btn-primary" onclick="addFood()">Yem At (2₺)</button>
          <button class="btn btn-teal" onclick="cleanTank()">Temizle</button>
        </div>

        <div class="mt-3">
          <div class="flex justify-between items-center mb-1">
            <label class="text-xs uppercase opacity-70">Sıcaklık Ayarı</label>
            <span class="mini" id="heaterLabel">Isıtıcı yok</span>
          </div>
          <input type="range" id="tempSlider" min="15" max="35" value="24" disabled
                 class="w-full h-2 bg-blue-900 rounded-lg appearance-none cursor-pointer">
        </div>

        <div class="mt-3">
          <button class="btn btn-red w-full" onclick="confirmReset()">Akvaryumu Sıfırla</button>
        </div>
      </div>

      <div class="section">
        <div class="text-xs uppercase opacity-70 mb-2">Market</div>
        <div class="grid gap-2">
          <button onclick="buyItem('filter')" id="buyFilter"
                  class="btn text-left">
            <div class="flex justify-between">
              <span>Otomatik Filtre</span><span class="price">500 ₺</span>
            </div>
            <div class="mini mt-1">Dışkıyı hızlı toplar, kirlilik etkisini azaltır.</div>
          </button>

          <button onclick="buyItem('heater')" id="buyHeater"
                  class="btn text-left">
            <div class="flex justify-between">
              <span>Termostatlı Isıtıcı</span><span class="price">300 ₺</span>
            </div>
            <div class="mini mt-1">Sıcaklığı hedefe yaklaştırır.</div>
          </button>

          <button onclick="buyItem('plant')" id="buyPlant"
                  class="btn text-left">
            <div class="flex justify-between">
              <span>Yapay Bitki</span><span class="price">100 ₺</span>
            </div>
            <div class="mini mt-1">Sadece estetik (şimdilik).</div>
          </button>
        </div>
      </div>

      <div id="log">
        <!-- event log items -->
      </div>
    </aside>
  </div>

  <!-- Reset Modal -->
  <div id="resetModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[1000] hidden flex items-center justify-center p-4">
    <div class="bg-slate-900 border border-slate-700 p-6 rounded-xl max-w-sm w-full">
      <h3 class="text-lg font-bold mb-2">Emin misiniz?</h3>
      <p class="text-slate-400 text-sm mb-6">Tüm ilerlemeniz silinecek.</p>
      <div class="flex gap-3">
        <button onclick="resetGame()" class="flex-1 bg-red-600 hover:bg-red-500 py-2 rounded font-bold">Sıfırla</button>
        <button onclick="closeResetModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 py-2 rounded">İptal</button>
      </div>
    </div>
  </div>

<script>
  const wrapper = document.getElementById('aquarium-wrapper');
  const canvas = document.getElementById('aquariumCanvas');
  const ctx = canvas.getContext('2d');

  // --------- Helpers ----------
  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
  function clamp01(v){ return clamp(v, 0, 1); }
  function randBetween(a, b){ return a + Math.random()*(b-a); }

  function formatTime(ms){
    const s = Math.floor(ms / 1000);
    return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
  }

  // Event log (zen gözlem)
  const MAX_LOG = 28;
  function pushLog(text){
    state.log.push({ t: Date.now(), text });
    if (state.log.length > MAX_LOG) state.log.shift();
  }
  function renderLog(){
    const el = document.getElementById('log');
    el.innerHTML = state.log
      .slice(-12)
      .map(x => `<div class="item">${x.text}</div>`)
      .join('');
  }

  // --------- Modifiers ----------
  const STATE_MODS = {
    hunger: {
      fed:   { move: 1.00, metabolism: 1.00, fertility: 1.00, deathRisk: 0.0 },
      hungry:{ move: 0.90, metabolism: 1.15, fertility: 0.45, deathRisk: 0.00005 },
      starv: { move: 0.70, metabolism: 1.40, fertility: 0.00, deathRisk: 0.0004 }
    },
    age: {
      baby:  { move: 1.20, metabolism: 1.20, fertility: 0.00, deathRisk: 0.00001 },
      adult: { move: 1.00, metabolism: 1.00, fertility: 1.00, deathRisk: 0.00002 },
      old:   { move: 0.80, metabolism: 0.90, fertility: 0.30, deathRisk: 0.0001 }
    },
    preg: {
      no:    { move: 1.00, metabolism: 1.00 },
      yes:   { move: 0.85, metabolism: 1.25 }
    },
    trait: {
      slow:  { move: 0.80, metabolism: 0.80 },
      normal:{ move: 1.00, metabolism: 1.00 },
      fast:  { move: 1.30, metabolism: 1.35 }
    }
  };

  let state = {
    money: 100,
    temp: 24,
    targetTemp: 24,
    cleanliness: 100,

    creatures: [],
    foods: [],
    plants: [],

    // NEW: poop + log
    poops: [],
    log: [],

    items: { filter: false, heater: false },
    lastTick: performance.now(),
    startTime: Date.now()
  };

  const MATURITY_TIME  = 10 * 60 * 1000;
  const MAX_LIFE       = 25 * 60 * 1000;
  const PREGNANCY_TIME = 5  * 60 * 1000;

  function envMods(temp, cleanliness){
    const dt = Math.abs(temp - 24);
    const tempStress = Math.max(0, (dt - 4) / 10);
    const dirtStress = Math.max(0, (60 - cleanliness) / 60);

    return {
      move: 1 - (0.2 * tempStress) - (0.15 * dirtStress),
      metabolism: 1 + (0.2 * tempStress) + (0.1 * dirtStress),
      fertility: 1 - (0.5 * dirtStress),
      deathRisk: (0.00005 * dirtStress) + (0.00004 * tempStress)
    };
  }

  function computeDerived(creature){
    const hState = creature.energy > 70 ? 'fed' : (creature.energy > 30 ? 'hungry' : 'starv');
    const ageState = (Date.now() - creature.bornTime) < MATURITY_TIME ? 'baby' : 'adult';
    const pState = creature.isPregnant ? 'yes' : 'no';

    // NEW: genes influence core multipliers (phenotype-ish)
    const geneMods = {
      move: 0.85 + creature.genes.speed * 0.5,
      metabolism: 0.85 + creature.genes.speed * 0.55,
      fertility: 0.70 + creature.genes.fertility * 0.60
    };

    const mods = [
      STATE_MODS.hunger[hState],
      STATE_MODS.age[ageState],
      STATE_MODS.preg[pState],
      STATE_MODS.trait[creature.trait],
      geneMods,
      envMods(state.temp, state.cleanliness)
    ];

    const out = { move: 1, metabolism: 1, fertility: 1, deathRisk: 0 };
    mods.forEach(m => {
      if (m.move) out.move *= m.move;
      if (m.metabolism) out.metabolism *= m.metabolism;
      if (m.fertility) out.fertility *= m.fertility;
      if (m.deathRisk) out.deathRisk += m.deathRisk;
    });

    out.move = Math.max(0.4, Math.min(2.0, out.move));
    return { ...out, hState };
  }

  // --------- Creature ----------
  class Creature {
    constructor(x, y, gender){
      this.id = Math.random().toString(36).substr(2, 9);
      this.x = x || 50 + Math.random() * (canvas.width - 100);
      this.y = y || 50 + Math.random() * (canvas.height - 150);

      this.gender = gender || (Math.random() > 0.5 ? 'M' : 'F');
      this.trait = ['slow', 'normal', 'fast'][Math.floor(Math.random() * 3)];

      // NEW: species + genes (future-ready)
      this.species = "basic";
      this.genes = {
        speed: randBetween(0, 1),
        fertility: randBetween(0, 1),
        waste: randBetween(0, 1) // how much poop/pollution per meal
      };

      // Visual hint: genes.speed slightly shifts brightness
      const base = (this.gender === 'M') ? { r: 96,  g: 165, b: 250 } : { r: 244, g: 114, b: 182 };
      const boost = 0.85 + this.genes.speed * 0.25;
      this.color = `rgb(${Math.floor(base.r*boost)},${Math.floor(base.g*boost)},${Math.floor(base.b*boost)})`;

      this.vx = (Math.random() - 0.5) * 3;
      this.vy = (Math.random() - 0.5) * 3;

      this.bornTime = Date.now();
      this.lifeSpan = 15 * 60 * 1000 + Math.random() * (10 * 60 * 1000);

      this.energy = 100;
      this.size = 2;

      this.isPregnant = false;
      this.lastBreedAttempt = 0;
      this.pregnancyStartTime = 0;

      // NEW: mate tracking + digestion queue -> poop events
      this.mateId = null;
      this.digestion = []; // [{t, amount}]
    }

    // Arrival Steering: Hedefe yaklaşırken yavaşlama (DT normalize)
    applyArrivalSteering(tx, ty, maxSpeed, maxForce, dtSec){
      const dx = tx - this.x;
      const dy = ty - this.y;
      const dist = Math.hypot(dx, dy) || 1e-6;

      const slowRadius = 140;
      const desiredSpeed = dist < slowRadius ? maxSpeed * (dist / slowRadius) : maxSpeed;

      const desiredVx = (dx / dist) * desiredSpeed;
      const desiredVy = (dy / dist) * desiredSpeed;

      let sx = desiredVx - this.vx;
      let sy = desiredVy - this.vy;

      const sm = Math.hypot(sx, sy) || 1e-6;
      const normalizedForce = maxForce * dtSec * 60;

      if (sm > normalizedForce){
        sx = (sx / sm) * normalizedForce;
        sy = (sy / sm) * normalizedForce;
      }

      this.vx += sx;
      this.vy += sy;
    }

    maybeDigestAndPoop(now){
      // trigger digestion events
      for (let i = this.digestion.length - 1; i >= 0; i--){
        if (now >= this.digestion[i].t){
          const amt = this.digestion[i].amount;

          state.poops.push({
            x: this.x + (Math.random() - 0.5) * 10,
            y: this.y + (Math.random() - 0.5) * 10,
            vy: 0.35 + Math.random() * 0.35,
            amount: amt,
            born: now
          });

          // Zen log: seyrek
          if (Math.random() < 0.08) pushLog("Dipte küçük izler belirdi.");
          this.digestion.splice(i, 1);
        }
      }
    }

    update(dtMs){
      const now = Date.now();
      const age = now - this.bornTime;
      const d = computeDerived(this);
      const dtSec = dtMs / 1000;

      // death risk (time-based)
      const survivalProb = Math.exp(-d.deathRisk * dtSec);
      if (age > this.lifeSpan || Math.random() > survivalProb){
        if (age > this.lifeSpan) showNotification("Bir canlı ömrünü tamamladı.");
        return false;
      }

      // energy burn
      const speedMag = Math.sqrt(this.vx**2 + this.vy**2);
      this.energy -= (0.01 + (speedMag * 0.005)) * d.metabolism * dtSec;
      this.energy = Math.max(0, this.energy);

      // growth
      if (age < MATURITY_TIME){
        this.size = 2 + (age / MATURITY_TIME) * 8;
      } else {
        this.size = 10 + ((age - MATURITY_TIME) / (MAX_LIFE - MATURITY_TIME)) * 5;
      }

      // damping
      this.vx *= 0.985;
      this.vy *= 0.985;

      // wander: tokken daha çok, açken daha az
      const wanderProb = (d.hState === 'fed' ? 0.03 : 0.01);
      if (Math.random() < wanderProb){
        this.vx += (Math.random() - 0.5) * 0.8;
        this.vy += (Math.random() - 0.5) * 0.8;
      }

      // speed cap
      const currentSpeed = Math.hypot(this.vx, this.vy);
      const maxAllowed = (d.hState === 'starv' ? 2.5 : (d.hState === 'hungry' ? 2.1 : 1.7)) * d.move;
      if (currentSpeed > maxAllowed){
        this.vx = (this.vx / currentSpeed) * maxAllowed;
        this.vy = (this.vy / currentSpeed) * maxAllowed;
      }

      // apply motion
      this.x += this.vx;
      this.y += this.vy;

      // clamp boundaries
      const left = 15, right = canvas.width - 15;
      const top = 15, bottom = canvas.height - 60;
      if (this.x < left)  { this.x = left;  this.vx = Math.abs(this.vx); }
      if (this.x > right) { this.x = right; this.vx = -Math.abs(this.vx); }
      if (this.y < top)   { this.y = top;   this.vy = Math.abs(this.vy); }
      if (this.y > bottom){ this.y = bottom;this.vy = -Math.abs(this.vy); }

      // birth
      if (this.isPregnant && now - this.pregnancyStartTime > PREGNANCY_TIME){
        const father = state.creatures.find(c => c.id === this.mateId) || null;
        this.giveBirth(father);
      }

      // digestion -> poop
      this.maybeDigestAndPoop(now);

      // food seeking
      this.findFood(d, dtSec);

      return true;
    }

    findFood(d, dtSec){
      // Tok balık yeme ilgi göstermez
      if (d.hState === 'fed') return;
      if (state.foods.length <= 0) return;

      const visionRange = d.hState === 'starv' ? 600 : 320;

      let nearest = null;
      let minDist = Infinity;

      for (const f of state.foods){
        const dist = Math.hypot(f.x - this.x, f.y - this.y);
        if (dist < visionRange && dist < minDist){
          minDist = dist; nearest = f;
        }
      }
      if (!nearest) return;

      const maxSpeed = (d.hState === 'starv' ? 2.2 : 1.7) * d.move;
      const maxForce = (d.hState === 'starv' ? 0.14 : 0.10);

      this.applyArrivalSteering(nearest.x, nearest.y, maxSpeed, maxForce, dtSec);

      // eat
      if (minDist < this.size + 10){
        state.foods = state.foods.filter(x => x !== nearest);
        this.energy = Math.min(100, this.energy + 40);
        this.vx *= 0.6; this.vy *= 0.6;

        // NEW: digestion event schedules poop later
        const baseDelay = 20000 + Math.random() * 30000; // 20-50s
        const wasteAmt = 0.7 + this.genes.waste * 1.2;    // ~0.7 - 1.9
        this.digestion.push({ t: Date.now() + baseDelay, amount: wasteAmt });

        if (Math.random() < 0.25) pushLog("Bir canlı sessizce beslendi.");
      }
    }

    draw(){
      const d = computeDerived(this);
      ctx.save();
      ctx.translate(this.x, this.y);
      ctx.globalAlpha = d.hState === 'starv' ? 0.6 : 1.0;
      ctx.fillStyle = this.color;

      if (this.size < 6){
        ctx.beginPath(); ctx.arc(0, 0, this.size, 0, Math.PI * 2); ctx.fill();
      } else {
        ctx.rotate(Math.atan2(this.vy, this.vx));
        ctx.beginPath(); ctx.ellipse(0, 0, this.size, this.size / 1.6, 0, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); ctx.moveTo(-this.size, 0); ctx.lineTo(-this.size-5, -5); ctx.lineTo(-this.size-5, 5); ctx.fill();
        if (this.isPregnant){
          ctx.fillStyle = 'white';
          ctx.beginPath(); ctx.arc(0, 2, this.size/3, 0, Math.PI*2); ctx.fill();
        }
      }
      ctx.restore();
    }

    giveBirth(father){
      this.isPregnant = false;
      const baby = new Creature(this.x, this.y); // gender random
      baby.species = this.species;

      // Inheritance: average + small mutation (future-ready)
      if (father){
        const mut = () => randBetween(-0.05, 0.05);
        baby.genes = {
          speed: clamp01(((this.genes.speed + father.genes.speed)/2) + mut()),
          fertility: clamp01(((this.genes.fertility + father.genes.fertility)/2) + mut()),
          waste: clamp01(((this.genes.waste + father.genes.waste)/2) + mut())
        };
      } else {
        // fallback (rare): slightly mutate mother genes
        baby.genes = {
          speed: clamp01(this.genes.speed + randBetween(-0.06, 0.06)),
          fertility: clamp01(this.genes.fertility + randBetween(-0.06, 0.06)),
          waste: clamp01(this.genes.waste + randBetween(-0.06, 0.06))
        };
      }

      // refresh baby color based on gene speed
      const base = (baby.gender === 'M') ? { r: 96,  g: 165, b: 250 } : { r: 244, g: 114, b: 182 };
      const boost = 0.85 + baby.genes.speed * 0.25;
      baby.color = `rgb(${Math.floor(base.r*boost)},${Math.floor(base.g*boost)},${Math.floor(base.b*boost)})`;

      state.creatures.push(baby);
      showNotification("Yeni bir yavru doğdu!");
      pushLog("Yeni bir yavru akıntıya karıştı.");
      this.mateId = null;
    }
  }

  // --------- Resize + init ----------
  function resize(){
    canvas.width = wrapper.clientWidth;
    canvas.height = wrapper.clientHeight;
  }
  window.addEventListener('resize', resize);

  function createBubble(){
    const b = document.createElement('div');
    b.className = 'bubble';
    const size = Math.random() * 8 + 2;
    b.style.width = size + 'px';
    b.style.height = size + 'px';
    b.style.left = Math.random() * 100 + '%';
    b.style.animationDuration = (Math.random() * 4 + 6) + 's';
    wrapper.appendChild(b);
  }

  function init(){
    resize();

    state.creatures = [];
    state.foods = [];
    state.plants = [];
    state.poops = [];
    state.log = [];

    state.startTime = Date.now();
    state.lastTick = performance.now();

    for (let i = 0; i < 3; i++) state.creatures.push(new Creature(null, null, 'M'));
    for (let i = 0; i < 3; i++) state.creatures.push(new Creature(null, null, 'F'));

    for (let i = 0; i < 15; i++) createBubble();

    pushLog("Su sakin. Sistem çalışıyor.");
    renderLog();
  }

  // --------- UI actions ----------
  function addFood(){
    if (state.money < 2){
      showNotification("Yeterli para yok!");
      return;
    }
    state.money -= 2;
    for (let i = 0; i < 6; i++){
      state.foods.push({
        x: 60 + Math.random() * (canvas.width - 120),
        y: 0,
        vy: 0.6 + Math.random() * 0.4
      });
    }
    pushLog("Yem serpildi.");
  }

  function cleanTank(){
    state.cleanliness = Math.min(100, state.cleanliness + 30);
    // cleaning also removes some old poop (zen reward)
    if (state.poops.length > 0){
      state.poops = state.poops.filter((_, idx) => idx % 2 === 0);
    }
    showNotification("Akvaryum temizlendi!");
    pushLog("Yüzeyler ferahladı.");
  }

  function buyItem(type){
    const prices = { filter: 500, heater: 300, plant: 100 };
    if (state.money < prices[type]){
      showNotification("Yeterli para yok!");
      return;
    }

    state.money -= prices[type];
    if (type === 'plant'){
      state.plants.push({ x: 50 + Math.random() * (canvas.width - 100), h: 40 + Math.random() * 60 });
      pushLog("Bir bitki eklendi.");
    } else {
      state.items[type] = true;
      document.getElementById('buy' + type.charAt(0).toUpperCase() + type.slice(1)).disabled = true;

      if (type === 'heater'){
        document.getElementById('tempSlider').disabled = false;
        document.getElementById('heaterLabel').textContent = "Isıtıcı aktif";
        pushLog("Isı dengeleniyor.");
      }
      if (type === 'filter'){
        pushLog("Filtre çalışmaya başladı.");
      }
    }

    showNotification("Eşya alındı!");
  }

  function confirmReset(){ document.getElementById('resetModal').classList.remove('hidden'); }
  function closeResetModal(){ document.getElementById('resetModal').classList.add('hidden'); }
  function resetGame(){ location.reload(); }

  function showNotification(t){
    const n = document.getElementById('notif');
    n.innerText = t;
    n.classList.remove('hidden');
    setTimeout(() => n.classList.add('hidden'), 3000);
  }

  // --------- Core loop ----------
  function updateLogic(dtMs){
    const now = Date.now();
    const dtSec = dtMs / 1000;

    // Environment temp
    if (state.items.heater){
      state.targetTemp = parseInt(document.getElementById('tempSlider').value);
      state.temp += (state.targetTemp - state.temp) * 0.012;
    } else {
      state.temp += (20 - state.temp) * 0.001;
    }

    // Food falling
    state.foods.forEach(f => {
      f.y += f.vy;
      if (f.y > canvas.height - 62) f.y = canvas.height - 62;
    });

    // Poop falling + pollution
    let poopPollution = 0;
    state.poops.forEach(p => {
      p.y += p.vy;
      if (p.y > canvas.height - 62) p.y = canvas.height - 62;
      poopPollution += 0.0022 * p.amount; // per tick; tuned for "zen slow"
    });

    // Filter effect: reduce pollution + slowly remove older poop
    if (state.items.filter){
      poopPollution *= 0.25;
      state.poops = state.poops.filter(p => (now - p.born) < 65000);
    }

    // Base bio-waste: small constant per creature (keeps system alive)
    const baseWaste = state.creatures.length * 0.00025; // gentle
    state.cleanliness = clamp(state.cleanliness - baseWaste - poopPollution, 0, 100);

    // Economy (simple zen loop)
    if (state.cleanliness > 60 && Math.abs(state.temp - 24) < 5){
      state.money += (state.creatures.length * 0.007);
    }

    // Creatures update
    state.creatures = state.creatures.filter(c => c.update(dtMs));

    // Breeding (adult + not pregnant + enough energy)
    const females = state.creatures.filter(c =>
      c.gender === 'F' &&
      (now - c.bornTime) > MATURITY_TIME &&
      !c.isPregnant &&
      c.energy > 42
    );
    const males = state.creatures.filter(c =>
      c.gender === 'M' &&
      (now - c.bornTime) > MATURITY_TIME &&
      c.energy > 42
    );

    females.forEach(f => {
      for (const m of males){
        const d = computeDerived(f);
        if (Math.hypot(f.x - m.x, f.y - m.y) < 40 && now - f.lastBreedAttempt > 20000){
          f.lastBreedAttempt = now;

          // Fertility also depends a bit on genes and cleanliness already in computeDerived
          const chance = 0.18 * d.fertility;
          if (Math.random() < chance){
            f.isPregnant = true;
            f.pregnancyStartTime = now;
            f.mateId = m.id;
            if (Math.random() < 0.35) pushLog("İki canlı bir anlığına yakınlaştı.");
          }
          break;
        }
      }
    });

    // UI update
    document.getElementById('moneyText').innerText = Math.floor(state.money) + " ₺";
    document.getElementById('tempText').innerText = state.temp.toFixed(1) + "°C";
    document.getElementById('cleanText').innerText = Math.floor(state.cleanliness) + "%";
    document.getElementById('fishCountText').innerText = state.creatures.length;
    document.getElementById('aquarium-timer').innerText = "Süre: " + formatTime(now - state.startTime);

    // Market buttons enabled/disabled
    const buyFilter = document.getElementById('buyFilter');
    const buyHeater = document.getElementById('buyHeater');
    const buyPlant  = document.getElementById('buyPlant');

    if (buyFilter) buyFilter.disabled = state.items.filter || state.money < 500;
    if (buyHeater) buyHeater.disabled = state.items.heater || state.money < 300;
    if (buyPlant)  buyPlant.disabled  = state.money < 100;

    // Heater label
    document.getElementById('heaterLabel').textContent = state.items.heater ? "Isıtıcı aktif" : "Isıtıcı yok";

    renderLog();
  }

  function draw(ts){
    const dtMs = Math.min(50, ts - state.lastTick);
    state.lastTick = ts;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Plants
    state.plants.forEach(p => {
      ctx.fillStyle = '#166534';
      ctx.beginPath();
      ctx.moveTo(p.x, canvas.height - 60);
      ctx.quadraticCurveTo(p.x + 10, canvas.height - 60 - p.h/2, p.x, canvas.height - 60 - p.h);
      ctx.quadraticCurveTo(p.x - 10, canvas.height - 60 - p.h/2, p.x, canvas.height - 60);
      ctx.fill();
    });

    // Food
    ctx.fillStyle = '#fbbf24';
    state.foods.forEach(f => {
      ctx.beginPath(); ctx.arc(f.x, f.y, 2.5, 0, Math.PI * 2); ctx.fill();
    });

    // Poop (NEW)
    ctx.fillStyle = 'rgba(60,40,20,0.82)';
    state.poops.forEach(p => {
      ctx.beginPath(); ctx.arc(p.x, p.y, 2.2, 0, Math.PI * 2); ctx.fill();
    });

    // Creatures
    state.creatures.forEach(c => c.draw());

    updateLogic(dtMs);
    requestAnimationFrame(draw);
  }

  window.onload = init;
  requestAnimationFrame(draw);
</script>
</body>
</html>
